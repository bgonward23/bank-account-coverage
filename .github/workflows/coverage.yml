name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 cmake
        pip install gcovr

    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_C_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build
      run: cmake --build build

    - name: Run Comparative Analysis
      run: |
        # ============================================
        # SETUP
        # ============================================
        find . -name "*.gcda" -delete
        echo "üìä THESIS COMPARISON REPORT" > comparison_results.txt
        echo "=============================================" >> comparison_results.txt

        # ============================================
        # ROUND 1: GITHUB COPILOT
        # ============================================
        echo "üß™ RUNNING ROUND 1: COPILOT"
        ./build/test_lru || true
        ./build/test_threadpool || true
        ./build/test_bank || true

        echo "--- COPILOT SCORES ---" >> comparison_results.txt
        echo "üìã LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nüåø BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # Cleanup for next round
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 2: GPT-4o
        # ============================================
        echo "üß™ RUNNING ROUND 2: GPT-4o"
        ./build/test_lru_3agent || true
        ./build/test_threadpool_3agent || true
        ./build/test_bank_3agent || true

        echo -e "\n--- GPT-4o SCORES ---" >> comparison_results.txt
        echo "üìã LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nüåø BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # Cleanup for next round
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 3: QWEN
        # ============================================
        echo "üß™ RUNNING ROUND 3: QWEN"
        ./build/test_lru_qwen || true
        ./build/test_threadpool_qwen || true
        ./build/test_bank_qwen || true

        echo -e "\n--- QWEN SCORES ---" >> comparison_results.txt
        echo "üìã LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nüåø BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # ============================================
        # FINAL CONSOLE REPORT
        # ============================================
        echo "#############################################"
        echo "      üèÜ FINAL THESIS COMPARISON REPORT      "
        echo "#############################################"
        cat comparison_results.txt

    - name: Generate HTML Detailed Report (Qwen Data)
      run: |
        mkdir coverage_html
        gcovr -r . -f src/ --gcov-executable gcov-12 --html --html-details -o coverage_html/index.html

    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_html/
