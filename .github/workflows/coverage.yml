name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Install GCC-12 for stability
        sudo apt-get install -y gcc-12 g++-12 cmake
        # Install gcovr (The better coverage tool for C++)
        pip install gcovr

    - name: Configure CMake
      run: |
        # Use GCC-12 and enable coverage flags
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_C_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build
      run: cmake --build build

    - name: Run Comparative Analysis (Copilot vs 3-Agent)
      run: |
        # ============================================
        # ROUND 1: GITHUB COPILOT
        # ============================================
        echo "---------------------------------------------------"
        echo "üß™ RUNNING ROUND 1: GITHUB COPILOT TESTS"
        echo "---------------------------------------------------"
        
        # 1. Run only Copilot tests (regex match for default names)
        # Assuming defaults are: test_lru, test_threadpool
        ctest -R "^test_lru$|^test_threadpool$" --output-on-failure

        # 2. Capture Score
        echo "üìä COPILOT COVERAGE SCORE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        
        # 3. RESET COUNTERS (Critical for comparison!)
        # We delete data files so Qwen starts from 0%
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 2: 3-AGENT FLOW (Qwen/GPT-4o)
        # ============================================
        echo "---------------------------------------------------"
        echo "üß™ RUNNING ROUND 2: 3-AGENT TESTS"
        echo "---------------------------------------------------"

        # 1. Run only 3-Agent tests (regex match for '3agent')
        ctest -R "3agent" --output-on-failure

        # 2. Capture Score
        echo -e "\nüìä 3-AGENT COVERAGE SCORE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt

        # ============================================
        # FINAL REPORT
        # ============================================
        echo "#############################################"
        echo "      üèÜ FINAL THESIS COMPARISON REPORT      "
        echo "#############################################"
        cat comparison_results.txt
