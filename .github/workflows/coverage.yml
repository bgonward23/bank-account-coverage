name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 cmake
        pip install gcovr

    - name: Configure CMake (Optimized for Instantiated Coverage)
      run: |
        # REMOVED: -fno-inline -fno-inline-small-functions -fno-default-inline
        # This will revert the total lines from 336 back to ~87 for ThreadPool
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -O0" \
          -DCMAKE_C_FLAGS="--coverage -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build
      run: cmake --build build

    - name: Run Comparative Analysis
      run: |
        # ============================================
        # SETUP
        # ============================================
        find . -name "*.gcda" -delete
        echo "ðŸ“Š THESIS COMPARISON REPORT (Instantiated Code)" > comparison_results.txt
        echo "=============================================" >> comparison_results.txt

        # ============================================
        # ROUND 1: GITHUB COPILOT
        # ============================================
        echo "ðŸ§ª RUNNING ROUND 1: COPILOT"
        ./build/test_lru || true
        ./build/test_threadpool || true
        ./build/test_bank || true

        echo "--- COPILOT SCORES ---" >> comparison_results.txt
        echo "ðŸ“‹ LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nðŸŒ¿ BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # Cleanup
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 2: GPT-4o
        # ============================================
        echo "ðŸ§ª RUNNING ROUND 2: GPT-4o"
        ./build/test_lru_3agent || true
        ./build/test_threadpool_3agent || true
        ./build/test_bank_3agent || true

        echo -e "\n--- GPT-4o SCORES ---" >> comparison_results.txt
        echo "ðŸ“‹ LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nðŸŒ¿ BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # Cleanup
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 3: QWEN
        # ============================================
        echo "ðŸ§ª RUNNING ROUND 3: QWEN"
        ./build/test_lru_qwen || true
        ./build/test_threadpool_qwen || true
        ./build/test_bank_qwen || true

        echo -e "\n--- QWEN SCORES ---" >> comparison_results.txt
        echo "ðŸ“‹ LINE COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        echo -e "\nðŸŒ¿ BRANCH COVERAGE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches >> comparison_results.txt

        # ============================================
        # FINAL REPORT
        # ============================================
        cat comparison_results.txt
