name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install LLVM 15 (Consistent Toolchain)
      run: |
        sudo apt-get update
        # Install a specific version (15) for all tools to prevent mismatch
        sudo apt-get install -y clang-15 llvm-15 cmake

    - name: Configure CMake
      run: |
        # Force CMake to use the version 15 compilers we just installed
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-15 \
          -DCMAKE_CXX_COMPILER=clang++-15 \
          -DCMAKE_C_FLAGS="-O0 -g -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_CXX_FLAGS="-O0 -g -fprofile-instr-generate -fcoverage-mapping"

    - name: Build
      run: cmake --build build

    - name: Run Tests
      run: |
        # %m creates a unique profile for each executable signature to avoid corruption
        export LLVM_PROFILE_FILE="build/code-%m.profraw"
        ctest --test-dir build --output-on-failure

    - name: Generate Coverage Report
      run: |
        # 1. Merge Profiles using the SAME version (llvm-profdata-15)
        llvm-profdata-15 merge -sparse build/*.profraw -o build/coverage.profdata

        # 2. Generate Report using the SAME version (llvm-cov-15)
        # Note: We list the exact executables so llvm-cov finds the instruction map
        llvm-cov-15 report \
          build/test_bank \
          -object build/test_lru \
          -object build/test_threadpool \
          -instr-profile=build/coverage.profdata \
          -ignore-filename-regex="test_.*" \
          -ignore-filename-regex="googletest/*"

