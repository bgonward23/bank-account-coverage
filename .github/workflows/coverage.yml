name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Install GCC-12 for stability
        sudo apt-get install -y gcc-12 g++-12 cmake
        # Install gcovr (The better coverage tool for C++)
        pip install gcovr

    - name: Configure CMake
      run: |
        # Use GCC-12 and enable coverage flags
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_C_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build
      run: cmake --build build

    - name: Run Comparative Analysis (Direct Execution)
      run: |
        # ============================================
        # SETUP: Define Artifacts
        # ============================================
        # Ensure we start clean
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 1: GITHUB COPILOT (Baseline)
        # ============================================
        echo "---------------------------------------------------"
        echo "üß™ RUNNING ROUND 1: GITHUB COPILOT TESTS"
        echo "---------------------------------------------------"
        
        # 1. Run the specific executables directly (Bypass CTest)
        # These names must match what is in your CMakeLists.txt add_executable()
        ./build/test_lru || true  # '|| true' allows script to continue even if tests fail
        ./build/test_threadpool || true
        ./build/test_bank || true

        # 2. Capture Score for Copilot
        echo "üìä COPILOT COVERAGE SCORE:" > comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        
        # 3. CLEANUP (Critical!)
        # Delete the .gcda files so Round 2 starts from 0%
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 2: 3-AGENT FLOW (Challenger)
        # ============================================
        echo "---------------------------------------------------"
        echo "üß™ RUNNING ROUND 2: 3-AGENT TESTS"
        echo "---------------------------------------------------"

        # 1. Run the specific 3-Agent executables directly
        ./build/test_lru_3agent || true
        ./build/test_threadpool_3agent || true
        ./build/test_bank_3agent || true

        # 2. Capture Score for 3-Agent
        echo -e "\nüìä 3-AGENT COVERAGE SCORE:" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt

        # ============================================
        # FINAL REPORT
        # ============================================
        echo "#############################################"
        echo "      üèÜ FINAL THESIS COMPARISON REPORT      "
        echo "#############################################"
        cat comparison_results.txt
